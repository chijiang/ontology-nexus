start: (action_def | rule_def)*

// ACTION Definition
action_def: "ACTION" entity_action "{" precondition+ effect? "}"

entity_action: CNAME "." CNAME ["(" param_list? ")"]

param_list: param ["," param]
param: CNAME ":" CNAME ["?"]

precondition: "PRECONDITION" [CNAME] ":" expression "ON_FAILURE" ":" STRING

effect: "EFFECT" "{" statement* "}"

// RULE Definition
rule_def: "RULE" CNAME priority? "{" trigger for_clause "}"

priority: "PRIORITY" NUMBER

trigger: "ON" trigger_type "(" trigger_target ")"

trigger_type: UPDATE | CREATE | DELETE | LINK | SCAN
trigger_target: CNAME ["." CNAME]

UPDATE: "UPDATE"
CREATE: "CREATE"
DELETE: "DELETE"
LINK: "LINK"
SCAN: "SCAN"

// Scope and Statements
for_clause: "FOR" "(" binding ")" "{" statement* "}"

binding: CNAME ":" CNAME ["WHERE" expression]

statement: set_stmt | trigger_stmt | for_clause

set_stmt: "SET" path "=" expression ";"

trigger_stmt: "TRIGGER" entity_action "ON" CNAME ["WITH" object] ";"

// Expressions
expression: or_expr

or_expr: and_expr (OR and_expr)*

and_expr: not_expr (AND not_expr)*

not_expr: [NOT] comparison

comparison: term [comp_op term]
    | term IN "[" [value_list] "]"
    | term IS [NOT] NULL
    | term MATCHES STRING
    | term CHANGED [FROM value TO value]
    | EXISTS "(" pattern ")"
    | term relationship term

comp_op: EQ | NEQ | LT | GT | LTE | GTE

term: path
    | value
    | function_call
    | "(" expression ")"

path: CNAME ("." CNAME)*

value: STRING
    | NUMBER
    | "true"
    | "false"

value_list: value ("," value)*

// Pattern Matching for EXISTS
pattern: CNAME [relationship CNAME] ["WHERE" expression]

relationship: "-" ["[" CNAME "]"] "->"

// Functions
function_call: CNAME "(" [arg_list] ")"

arg_list: expression ["," expression]

// Objects
object: "{" [member ["," member]] "}"

member: CNAME ":" expression

// Terminals
STRING: /"[^"]*"/
NUMBER: /[0-9]+(\.[0-9]+)?/
CNAME: /[a-zA-Z_][a-zA-Z0-9_]*/

// Logical operators
AND: "AND"
OR: "OR"

// Comparison operators (must be defined before %import to avoid conflicts)
EQ: "==" | "="
NEQ: "!="
LT: "<"
GT: ">"
LTE: "<="
GTE: ">="

IN: "IN"
IS: "IS"
NOT: "NOT"
NULL: "NULL"
MATCHES: "MATCHES"
CHANGED: "CHANGED"
FROM: "FROM"
TO: "TO"
EXISTS: "EXISTS"

%import common.WS
%ignore WS
%ignore /\/\/[^\n]*/
